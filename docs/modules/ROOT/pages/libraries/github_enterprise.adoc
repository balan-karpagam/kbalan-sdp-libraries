= GitHub Enterprise

This library is unique in that rather than provide functional step implementations, it provides methods that help with the business logic
defined within pipeline templates.

[NOTE]
====
It also provides additional functionality that can be useful for library developers to get scm metadata or interact with a remote github repository.
====

== Configuration

[source,groovy]
----
libraries{
  github_enterprise
}
----

== Pipeline Template Business Logic

The GitHub Enterprise library contributes some helper methods to help with pipeline template orchestration.  You can achieve fine grained control over what happens when in response to different GitHub events such as commits, pull requests, and merges.

.GitHub Flow Helper Methods
|===
| Method | Build Cause

| on_commit
| A direct commit to a branch

| on_pull_request
| A pull request was created or a developer pushed a commit to the source branch

| on_merge
| A pull request was merged into the branch.

| on_change
| A combination of `on_commit` and `on_pull_request`

|===

These methods take named parameters `to` and `from` indicating direction of the github whose value is a regular expression to compare the branch names against.

SDP provides some default keywords for branch name regular expressions:

.Default Branch Regular Expressions
|===
| Keyword | Regular Expression

| master
| /^[Mm]aster$/

| develop
| /^[Dd]evelop(ment|er|)$/

| hotfix
| /^[Hh]ot[Ff]ix-/

| release
| /^[Rr]elease-(d+.)*d$/
 
|===

[NOTE]
====
These branch name regular expressions are not a part of the GitHub Enterprise library but rather leveraged by defining Keywords in the Pipeline configuration file
====

== Example Pipeline Templates

*Full example using keywords*

[source,groovy]
----
on_commit{
  continuous_integration()
}

on_pull_request to: develop, {
  continuous_integration()
  deploy_to dev
  parallel "508 Testing": { accessibility_compliance_test() },
          "Functional Testing": { functional_test() },
          "Penetration Testing": { penetration_test() }
  deploy_to staging
  performance_test()
}

on_merge to: master, from: develop, {
  deploy_to prod
  smoke_test()
}
----

*Example using regular expressions directly*

[source,groovy]
----
on_commit to: /^[Ff]eature-.*/, {
  // will be triggered on feature branches
}
on_pull_request from: /^[Ff]eature-.*/, to: develop, {
  // will be triggered on PR's from feature to develop
}
----

*Example using on_change*

[source,groovy]
----
on_change{
  // do CI on every commit or PR
  continuous_integration()
}
on_pull_request to: master, {
  // do some stuff on PR to master
}
on_merge to: master, {
  // PR was merged into master
}
----
== Additional Common Configuration Options for SDP library steps
.Common Configuration Options
|===
| *Field* | *Description* | *Default Value*

| agentType
| This sets the agentType of the jenkins agent on which this step should be run. This value overrides the settings in the SDP library. Possible values are "kubernetes" "docker" and "generic".
| value from default SDP library configuration else "generic"

| nodeLabel
| This provides the label of the static jenkins agent on which to execute this pipeline step. This value is applicable for agentType "docker" and "generic". For "kubernetes" agent type, the nodes are dynamically launched and the label is automaticaly generated.
| value from default SDP library configuration else none

| images
| This block is used when agentType is "docker". It provies information on accessing the Docker image this step  needs to use. The values in this block overrrides the values in the SDP library configuration. Nonetheless, using the combination of what is declared here and the default SDP library configuration values, this library step must be able to access and pull the image it needs from the registry
|

| images.registry
| This sets the registry the where this step expects to find its Docker images
| value from default SDP library configuration else none

| images.repository
| The first https://forums.docker.com/t/docker-registry-v2-spec-and-repository-naming-rule/5466[path component] in the repository name, e.g. if your images follow the format ``my-registry.com/sdp/*``, this would be *sdp*
| value from default SDP library configuration else none

| images.cred
| Credentials used to pull images from the specified repository
| value from default SDP library configuration else none

| images.img
| Name of the default image to use
| 

| images.docker_args
| Arguments to use when starting the container. Uses the same flags as `docker run`
| value from default SDP library configuration else none

| podSpec
| This block is used when agentType is "kubernetes". It provies information on accessing the container images that needs to be used to launch a dynamic pod in which this step is to be executed. The values in this block overrrides  the values in the SDP library configuration. Nonetheless, using the combination of what is declared here and in the SDP library configuration values, the step must be able to access and pull the image it needs from the registry. In addition to information on the container image, this block also provides the namespace in which to launch the pod and the cloud / cluster into which the pod must be launched
|

| podSpec.registry
| This sets the registry the library step expects to find the container images
| value from default SDP library configuration else none

| podSpec.repository
| The first https://forums.docker.com/t/docker-registry-v2-spec-and-repository-naming-rule/5466[path component] in the repository name, e.g. if your images follow the format ``my-registry.com/sdp/*``, this would be *sdp*
| value from default SDP library configuration else none

| podSpec.cred
| Credentials used to pull images from the specified repository
| value from default SDP library configuration else none

| podSpec.img
| Name of the image to use
| 

| podSpec.cloud
| Name of the kubernetes cluster / cloud as defined in the Jenkins master configuration to launch the pod in
| value from default SDP library configuration else  "kubernetes"

| podSpec.namespace
| Name of the kubernetes namespace to launch the pod in (this namespace must exist in the cluster)
| value from default SDP library configuration else default

|===

[IMPORTANT]
====

The value in "images.registry" _does_ include the protocol (http/https) while the value in "podSpec.registry" does not include the protocol (http/https).

====

== Example Configuration Snippet - Common Configuration Options

[source,groovy]
----
libraries{
  agentType = "kubernetes"
  podSpec{
    cloud = "prod-cluster"
    namespace = "sdp"
    registry = "docker-registry.default.svc:5000"
    repository = "sdp"
    cred = "docker-registry-secret"
    img = "default-centos"
  }
}

or

libraries{
  agentType = "docker"
  nodeLabel = "sdp-agent"
  images{
    registry = "https://docker-registry.default.svc:5000"
    repository = "sdp"
    cred = "docker-registry-secret"
    docker_args = ""
    img = "default-centos"
  }
}

or

libraries{
  agentType = "generic"
  nodeLabel = "sdp-agent"
}

----
=== External Dependencies

=== Troubleshooting

=== FAQ
